<controls:NewStepControl xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                         xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                         xmlns:local="clr-namespace:Keysight.OpenTap.Wpf"
                         xmlns:controls="clr-namespace:Keysight.OpenTap.Wpf"
                         xmlns:managers="clr-namespace:Keysight.Ccl.Wsl.UI.Managers;assembly=Keysight.Ccl.Wsl"
                         Name="this" VerticalAlignment="Stretch" FontSize="{DynamicResource WslMediumFontSizeKey}"
                         Background="Transparent"
                         managers:HelpManager.HelpLink="EditorHelp.chm::/CreatingATestPlan/Working With Test Steps/Adding a New Step.html">
  <FrameworkElement.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="/Keysight.OpenTap.Wpf;component/DefaultStyle.xaml"/>
        <ResourceDictionary Source="/Keysight.OpenTap.Wpf;component/Themes/Generic.xaml"/>
        <ResourceDictionary>
          <controls:AutomationIdConverter x:Key="AutomationIdConverter"/>
        </ResourceDictionary>
      </ResourceDictionary.MergedDictionaries>
      <Style BasedOn="{StaticResource {x:Type TreeViewItem}}" TargetType="{x:Type TreeViewItem}">
        <Setter Property="TreeViewItem.IsExpanded" Value="{Binding Expanded, Mode=TwoWay}"/>
        <Setter Property="TreeViewItem.IsSelected" Value="{Binding IsSelected}"/>
        <Setter Property="Control.Padding" Value="0"/>
        <Setter Property="AutomationProperties.AutomationId"
                Value="{Binding Converter={StaticResource AutomationIdConverter}}"/>
        <Style.Triggers>
          <DataTrigger Binding="{Binding DataContext.IsFiltering, ElementName=basegrid}" Value="True">
            <Setter Property="UIElement.Visibility" Value="Visible"/>
            <Setter Property="TreeViewItem.IsExpanded" Value="True"/>
          </DataTrigger>
          <DataTrigger Binding="{Binding IsShown}" Value="False">
            <Setter Property="UIElement.Visibility" Value="Collapsed"/>
          </DataTrigger>
        </Style.Triggers>
      </Style>
      <HierarchicalDataTemplate x:Key="{DataTemplateKey {x:Type controls:NewStepControl+StepCategoryViewModel}}"
                                DataType="{x:Type controls:NewStepControl+StepCategoryViewModel}" ItemsSource="{Binding Children}">
        <StackPanel Orientation="Horizontal">
          <TextBlock VerticalAlignment="Center" Padding="2,0" Margin="0,0,6,2"
                     Text="{Binding Name, Converter={controls:StringTrimmingConverter}}"/>
          <Button Visibility="Hidden" Content="" FontWeight="Normal" Margin="2" HorizontalAlignment="Center"
                  VerticalAlignment="Center"/>
        </StackPanel>
      </HierarchicalDataTemplate>
      <DataTemplate DataType="{x:Type controls:NewStepControl+StepTypeViewModel}">
        <Grid Background="Transparent">
          <FrameworkElement.ContextMenu>
            <ContextMenu>
              <MenuItem Header="Show Plugin Package..."/>
              <MenuItem Header="Show Help" Command="Help" InputGestureText=""
                        ToolTip="Show the help documentation for this plugin type. If this button is disabled, then the help documentation is not available."
                        ToolTipService.ShowOnDisabled="True" managers:HelpManager.HelpLink="{Binding HelpLink}"
                        IsEnabled="{Binding HasHelpLink}"/>
            </ContextMenu>
          </FrameworkElement.ContextMenu>
          <TextBlock Padding="2,0" Margin="0,0,110,0" TextTrimming="CharacterEllipsis" VerticalAlignment="Center"
                     Text="{Binding Name}">
            <FrameworkElement.ToolTip>
              <ToolTip>
                <StackPanel MaxWidth="400" MaxHeight="500">
                  <TextBlock FontWeight="Bold" TextTrimming="CharacterEllipsis" TextWrapping="Wrap" Text="{Binding Name}"/>
                  <TextBlock Opacity="0.9" TextTrimming="CharacterEllipsis" TextWrapping="Wrap"
                             Text="{Binding ImplementingAssembly}"/>
                  <TextBlock x:Name="descriptionText" Margin="0,10,0,0" TextWrapping="Wrap" TextTrimming="CharacterEllipsis"
                             Opacity="0.6" Text="{Binding Description}"
                             Visibility="{Binding Description, Converter={controls:StringToVisibilityConverter}}"/>
                </StackPanel>
              </ToolTip>
            </FrameworkElement.ToolTip>
          </TextBlock>
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Right"
                      KeyboardNavigation.DirectionalNavigation="None">
            <Button Name="addBtn" Command="{x:Static controls:NewStepControl.AddStep}" FontWeight="Normal" Margin="2,1"
                    HorizontalAlignment="Center" VerticalAlignment="Center" CommandParameter="{Binding}"
                    IsEnabled="{Binding CanAddSib}">
              <FrameworkElement.ToolTip>
                <TextBlock x:Name="addStepToolTipText"/>
              </FrameworkElement.ToolTip>Add</Button>
            <Border Name="addChildBorder" Margin="2,1" Background="Transparent">
              <Button Name="addChildBtn" Command="{x:Static controls:NewStepControl.AddChildStep}" FontWeight="Normal"
                      VerticalAlignment="Center" HorizontalAlignment="Center" CommandParameter="{Binding}"
                      Visibility="{Binding DataContext.AddChildVisibility, ElementName=basegrid}">
                <FrameworkElement.ToolTip>
                  <TextBlock Text="{Binding Name, StringFormat='Add {0} as a child below selected step.'}"/>
                </FrameworkElement.ToolTip>Add Child</Button>
            </Border>
          </StackPanel>
        </Grid>
        <DataTemplate.Triggers>
          <DataTrigger Value="Visible" Binding="{Binding DataContext.AddChildVisibility, ElementName=basegrid}">
            <Setter TargetName="addStepToolTipText" Value="{Binding Name, StringFormat='Add {0} below selected step.'}"
                    Property="TextBlock.Text"/>
          </DataTrigger>
          <DataTrigger Value="Collapsed" Binding="{Binding DataContext.AddChildVisibility, ElementName=basegrid}">
            <Setter TargetName="addStepToolTipText" Value="{Binding Name, StringFormat='Add {0}.'}"
                    Property="TextBlock.Text"/>
          </DataTrigger>
          <DataTrigger Value="False" Binding="{Binding DataContext.CanAdd, ElementName=basegrid}">
            <Setter TargetName="addBtn" Property="UIElement.IsEnabled" Value="False"/>
          </DataTrigger>
          <DataTrigger Value="False" Binding="{Binding DataContext.CanAddChild, ElementName=basegrid}">
            <Setter TargetName="addChildBtn" Property="UIElement.IsEnabled" Value="False"/>
          </DataTrigger>
        </DataTemplate.Triggers>
      </DataTemplate>
    </ResourceDictionary>
  </FrameworkElement.Resources>
  <Grid Name="basegrid" Row="0" Margin="4,0" IsEnabled="{Binding IsAddingEnabled, ElementName=this}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>
    <Border Margin="0,4" Grid.Row="0">
      <Grid>
        <TextBox Name="FilterTextBox" Margin="3"
                 Text="{Binding Filter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
        <TextBlock IsHitTestVisible="False" Opacity="0.6" VerticalAlignment="Center" Margin="12,0,0,0"
                   Visibility="{Binding IsFiltering, Converter={controls:VisibilityConverter}, ConverterParameter={x:Static Visibility.Visible}}">Search...</TextBlock>
        <Button Width="13" Height="13" Margin="0,0,6,0" HorizontalAlignment="Right"
                Visibility="{Binding IsFiltering, Converter={controls:VisibilityConverter}}">
          <Control.Template>
            <ControlTemplate>
              <Rectangle Fill="{DynamicResource failColor}">
                <UIElement.OpacityMask>
                  <ImageBrush ImageSource="{DynamicResource CancelIcon}"/>
                </UIElement.OpacityMask>
              </Rectangle>
            </ControlTemplate>
          </Control.Template>
        </Button>
        <Rectangle Width="13" Height="13" Margin="0,0,6,0" HorizontalAlignment="Right" Opacity="0.5"
                   Fill="{DynamicResource Control.Static.Foreground}"
                   Visibility="{Binding IsFiltering, Converter={controls:VisibilityConverter}, ConverterParameter={x:Static Visibility.Visible}}">
          <UIElement.OpacityMask>
            <ImageBrush ImageSource="{DynamicResource SearchIcon}"/>
          </UIElement.OpacityMask>
        </Rectangle>
      </Grid>
    </Border>
    <Border Grid.Row="1">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="*"/>
          <RowDefinition Height="20"/>
          <RowDefinition Height="70" MinHeight="30" MaxHeight="200"/>
        </Grid.RowDefinitions>
        <TreeView Name="tree" Grid.Row="0" Grid.Column="1" Margin="0,0,0,1" HorizontalContentAlignment="Stretch"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled" VirtualizingPanel.IsVirtualizing="True"
                  Grid.IsSharedSizeScope="True" IsTabStop="False" Focusable="False"
                  ItemsSource="{Binding AvailableTypes}">
          <ItemsControl.ItemContainerStyle>
            <Style TargetType="{x:Type TreeViewItem}" BasedOn="{StaticResource {x:Type TreeViewItem}}">
            </Style>
          </ItemsControl.ItemContainerStyle>
        </TreeView>
        <GridSplitter Height="5" Grid.Row="1" Background="{DynamicResource Tap.Window.Background}" BorderThickness="0"
                      ResizeBehavior="PreviousAndNext" HorizontalAlignment="Stretch" IsTabStop="False"/>
        <ScrollViewer Grid.Row="2" Background="{DynamicResource Tap.Panel.Background}" VerticalAlignment="Stretch"
                      HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto"
                      AutomationProperties.AutomationId="TestStepDescriptionScrollViewer">
          <TextBox Grid.Column="0" Background="{DynamicResource Tap.Panel.Background}" IsHitTestVisible="False"
                   IsReadOnly="True" Margin="10,3,6,3" BorderThickness="0" VerticalAlignment="Top" TextWrapping="Wrap"
                   AutomationProperties.AutomationId="TestStepDescription" AcceptsReturn="True"
                   Text="{Binding SelectedItem.Description, Mode=OneWay}"/>
        </ScrollViewer>
      </Grid>
    </Border>
  </Grid>
</controls:NewStepControl>