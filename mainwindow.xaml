<gui:MainWindow xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:local="clr-namespace:Keysight.OpenTap.Gui"
                xmlns:controls="clr-namespace:Keysight.OpenTap.Wpf;assembly=Keysight.OpenTap.Wpf"
                xmlns:tap="clr-namespace:OpenTap;assembly=OpenTap"
                xmlns:ui="clr-namespace:Keysight.Ccl.Wsl.UI;assembly=Keysight.Ccl.Wsl"
                xmlns:WslManagers="clr-namespace:Keysight.Ccl.Wsl.UI.Managers;assembly=Keysight.Ccl.Wsl"
                xmlns:mgr="clr-namespace:Keysight.Ccl.Wsl.UI.Managers;assembly=Keysight.Ccl.Wsl"
                xmlns:system="clr-namespace:System;assembly=mscorlib"
                xmlns:gui="clr-namespace:Keysight.OpenTap.Gui"
                Name="at" Title="Test Automation" MinHeight="400" MinWidth="400" FocusManager.IsFocusScope="True"
                WindowStartupLocation="CenterScreen" Focusable="True" AllowDrop="True" ResizeMode="CanResize"
                AutomationProperties.AutomationId="MainWindow" HasHelpButton="True"
                mgr:HelpManager.HelpLink="EditorHelp.chm"
                IsEnabled="{Binding Path=StartupCompleted, ElementName=at}">
  <FrameworkElement.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="/Keysight.OpenTap.Wpf;component/DefaultStyle.xaml"/>
        <ResourceDictionary Source="/Editor;component/Style.xaml"/>
        <ResourceDictionary Source="/Keysight.OpenTap.Wpf;component/Themes/Generic.xaml"/>
      </ResourceDictionary.MergedDictionaries>
      <gui:RemainingTextConverter x:Key="remainingTextConverter"/>
      <gui:DurationToProgressStateConverter x:Key="durationToProgressState"/>
      <gui:DurationToProgressConverter x:Key="durationToProgress"/>
      <gui:IntNotZeroToBoolConverter x:Key="intNotZeroToBoolConverter"/>
    </ResourceDictionary>
  </FrameworkElement.Resources>
  <Window.TaskbarItemInfo>
    <TaskbarItemInfo>
      <TaskbarItemInfo.ProgressState>
        <MultiBinding Converter="{StaticResource durationToProgressState}">
          <Binding Path="Duration" ElementName="at"/>
          <Binding Path="TestPlanListener.AverageDuration" ElementName="at"/>
          <Binding Path="Plan.IsRunning" ElementName="at"/>
          <Binding Path="Verdict" ElementName="bv"/>
        </MultiBinding>
      </TaskbarItemInfo.ProgressState>
      <TaskbarItemInfo.ProgressValue>
        <MultiBinding Converter="{StaticResource durationToProgress}">
          <Binding Path="Duration" ElementName="at"/>
          <Binding Path="TestPlanListener.AverageDuration" ElementName="at"/>
          <Binding Path="Plan.IsRunning" ElementName="at"/>
        </MultiBinding>
      </TaskbarItemInfo.ProgressValue>
    </TaskbarItemInfo>
  </Window.TaskbarItemInfo>
  <UIElement.CommandBindings>
    <CommandBinding Command="local:MainWindow.NewPlanCommand"/>
    <CommandBinding Command="Open"/>
    <CommandBinding Command="Save"/>
    <CommandBinding Command="SaveAs"/>
    <CommandBinding Command="Undo"/>
    <CommandBinding Command="Redo"/>
    <CommandBinding Command="local:MainWindow.Undo"/>
    <CommandBinding Command="local:MainWindow.Redo"/>
    <CommandBinding Command="Close"/>
    <CommandBinding Command="local:MainWindow.AddStep"/>
    <CommandBinding Command="local:TestPlanGrid.Paste"/>
    <CommandBinding Command="local:MainWindow.StopTestPlan"/>
    <CommandBinding Command="local:MainWindow.RunTestPlan"/>
    <CommandBinding Command="local:MainWindow.PauseTestPlan"/>
    <CommandBinding Command="local:MainWindow.InitTestPlan"/>
    <CommandBinding Command="local:MainWindow.RunStep"/>
    <CommandBinding Command="local:MainWindow.StepTestPlan"/>
    <CommandBinding Command="local:MainWindow.RenameStep"/>
    <CommandBinding Command="controls:PropGrid.MonitorProperty"/>
    <CommandBinding Command="controls:PropGrid.RemoveMonitorProperty"/>
    <CommandBinding Command="controls:TapSettings.Open"/>
    <CommandBinding Command="controls:ExternalTestPlanParameters.ShowCommand"/>
    <CommandBinding Command="local:MainWindow.AddPlan"/>
    <CommandBinding Command="local:MainWindow.ToggleFocusModeCommand"/>
    <CommandBinding Command="local:PresetsMenuItem.SetPresetCommandKey1"/>
    <CommandBinding Command="local:PresetsMenuItem.SetPresetCommandKey2"/>
    <CommandBinding Command="local:PresetsMenuItem.SetPresetCommandKey3"/>
    <CommandBinding Command="local:PresetsMenuItem.SetPresetCommandKey4"/>
    <CommandBinding Command="local:PresetsMenuItem.SavePreset"/>
    <CommandBinding Command="local:MainWindow.CheckForUpdatesCommand"/>
    <CommandBinding Command="local:MainWindow.ShowLicenseManagerCommand"/>
  </UIElement.CommandBindings>
  <ui:WslMainWindow.MenuContentTemplate>
    <ControlTemplate>
      <Decorator Name="menuContent">
        <Grid Visibility="{Binding FocusModeEnabled, ElementName=at, Converter={controls:VisibilityConverter}, ConverterParameter={x:Static Visibility.Visible}}"/>
      </Decorator>
    </ControlTemplate>
  </ui:WslMainWindow.MenuContentTemplate>
  <Grid x:Name="au" Margin="0" Focusable="True" KeyboardNavigation.IsTabStop="False">
    <Grid.RowDefinitions>
      <RowDefinition x:Name="av" Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    <FrameworkElement.Resources>
      <DataTemplate x:Key="panelTitleTemplate">
        <Label Name="label" FontSize="14" Foreground="{DynamicResource Control.Static.Foreground}" Padding="4,0"
               VerticalAlignment="Center" FontWeight="Normal" Background="Transparent" Content="{Binding Title}"
               Tag="{Binding}"/>
        <DataTemplate.Triggers>
          <DataTrigger Value="True" Binding="{Binding Path=IsActive}">
            <Setter TargetName="label" Value="{DynamicResource Tap.Highlight}" Property="Control.Foreground"/>
          </DataTrigger>
          <DataTrigger Value="Test Plan" Binding="{Binding Title}">
            <Setter TargetName="label" Property="ContentControl.Content">
              <Setter.Value>
                <TextBlock>
                  <TextBlock Margin="0,0,3,0" FontWeight="Normal">Test Plan</TextBlock>
                  <TextBlock Foreground="{DynamicResource GridView.ColumnHeader.Static.Foreground}" FontWeight="Normal"
                             Margin="1,0,0,0" FontStyle="Italic" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"
                             AutomationProperties.AutomationId="TestPlanName" Text="{Binding Content.LegacyContext.Plan.Name}"/>
                  <TextBlock Foreground="{DynamicResource GridView.ColumnHeader.Static.Foreground}" Text="*"
                             AutomationProperties.AutomationId="TestPlanIsDirty" Width="8"
                             Visibility="{Binding Content.LegacyContext.IsPlanDirty, Converter={controls:VisibilityConverter}}"/>
                  <Rectangle Opacity="0.6" Fill="{DynamicResource Locked}" Width="12" Height="12" Margin="0,0,0,-1"
                             ToolTip="The Test Plan is locked and cannot be edited, to unlock use the File Menu."
                             Visibility="{Binding Content.LegacyContext.Plan.Locked, Converter={controls:VisibilityConverter}}"/>
                </TextBlock>
              </Setter.Value>
            </Setter>
          </DataTrigger>
        </DataTemplate.Triggers>
      </DataTemplate>
    </FrameworkElement.Resources>
    <Grid Name="aw">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="Auto"/>
      </Grid.ColumnDefinitions>
      <Menu Name="ax" VerticalAlignment="Top">
        <MenuItem Name="ay" Header="_File">
          <MenuItem Header="_New" Command="local:MainWindow.NewPlanCommand"
                    AutomationProperties.AutomationId="FileMenu NewPlan" CommandTarget="{Binding ElementName=at}"/>
          <MenuItem Header="_Open" Command="Open" AutomationProperties.AutomationId="FileMenu OpenPlan"
                    CommandTarget="{Binding ElementName=at}"/>
          <MenuItem Header="_Save" Command="Save" AutomationProperties.AutomationId="FileMenu SavePlan"
                    CommandTarget="{Binding ElementName=at}"/>
          <MenuItem Header="S_ave As..." Command="SaveAs" AutomationProperties.AutomationId="FileMenu SaveAsPlan"
                    CommandTarget="{Binding ElementName=at}"/>
          <Separator Name="az"/>
          <MenuItem Name="a0" Header="Import" AutomationProperties.AutomationId="FileMenu Import"
                    IsEnabled="{Binding GotLicense, ElementName=at}"/>
          <MenuItem Name="a1" Header="Export" AutomationProperties.AutomationId="FileMenu Export"
                    IsEnabled="{Binding GotLicense, ElementName=at}"/>
          <Separator/>
          <MenuItem Tag="lock" Header="_Lock Test Plan" IsEnabled="{Binding GotLicense, ElementName=at}"
                    Visibility="{Binding Plan.Locked, ElementName=at, Converter={controls:VisibilityConverter}, ConverterParameter={x:Static Visibility.Visible}}"/>
          <MenuItem Tag="unlock" Header="_Unlock Test Plan" IsEnabled="{Binding GotLicense, ElementName=at}"
                    Visibility="{Binding Plan.Locked, ElementName=at, Converter={controls:VisibilityConverter}}"/>
          <Separator Name="a2"/>
          <Separator Name="a3"/>
          <MenuItem Header="E_xit" Command="Close" AutomationProperties.AutomationId="FileMenu Close"
                    CommandTarget="{Binding ElementName=at}"/>
        </MenuItem>
        <controls:SettingsMenuItem Header="Settings" IsEnabled="{Binding GotLicense, ElementName=at}"
                                   DataContext="{Binding TapSettings.AllSettings, ElementName=at}"/>
        <MenuItem Name="a4" Header="_Tools"/>
        <MenuItem Name="a5" Header="_View">
          <MenuItem Name="a6" Header="Panels"/>
          <gui:PresetsMenuItem x:Name="a7" OnSaving="d" OnLoadedPreset="c" Height="{StaticResource Tap.MenuItem.Height}"/>
        </MenuItem>
        <MenuItem Header="_Help">
          <MenuItem Name="a8" Header="_Welcome" Tag="EditorHelp.chm::/Welcome/ReadmeMain.html"/>
          <MenuItem Name="a9" Header="Getting _Started..." Tag="EditorHelp.chm::/Getting Started/Readme.html"/>
          <MenuItem Name="ba" Header="_How to..." Tag="EditorHelp.chm::/Getting Started/How To Quick Reference.html"/>
          <MenuItem Name="bb" Header="_Online Documentation..."/>
          <Separator/>
          <MenuItem Command="local:MainWindow.ShowLicenseManagerCommand" Header="_License Manager..."
                    ToolTip="Open the Keysight License Manager."
                    Visibility="{Binding IsEnabled, RelativeSource={RelativeSource Mode=Self}, Converter={controls:VisibilityConverter}}"
                    CommandTarget="{Binding ElementName=at}"/>
          <MenuItem Command="local:MainWindow.CheckForUpdatesCommand" Header="_Check For Updates..."
                    ToolTip="Open the package manager and check for updates."
                    Visibility="{Binding IsEnabled, RelativeSource={RelativeSource Mode=Self}, Converter={controls:VisibilityConverter}}"
                    CommandTarget="{Binding ElementName=at}"/>
          <Separator/>
          <MenuItem Name="bc" Header="_About Test Automation..." IsEnabled="True"/>
        </MenuItem>
      </Menu>
      <StackPanel Name="bd" Grid.Column="3" Orientation="Horizontal"/>
      <TextBox x:Name="be" Grid.Column="1" Panel.ZIndex="10" Margin="0,0,8,0" IsReadOnly="True"
               Foreground="{DynamicResource Control.Disabled.Foreground}" HorizontalAlignment="Right"
               VerticalAlignment="Center" Text="" FontStyle="Italic" FontWeight="Light" BorderThickness="0"
               Opacity="0.8">
        <FrameworkElement.ContextMenu>
          <ContextMenu Visibility="Collapsed"/>
        </FrameworkElement.ContextMenu>
        <FrameworkElement.Style>
          <Style TargetType="{x:Type TextBox}">
            <Style.Triggers>
              <Trigger Property="UIElement.Focusable" Value="True">
                <Setter Property="Control.Background" Value="Transparent"/>
              </Trigger>
            </Style.Triggers>
          </Style>
        </FrameworkElement.Style>
      </TextBox>
      <Label Grid.Column="2" Panel.ZIndex="10" Margin="0,0,6,0"
             Foreground="{DynamicResource Control.Disabled.Foreground}" HorizontalAlignment="Right"
             VerticalAlignment="Center" FontStyle="Italic" FontWeight="Light" Opacity="0.8"
             IsHitTestVisible="true">
        <FrameworkElement.Style>
          <Style TargetType="{x:Type Label}">
            <Setter Property="Control.Template">
              <Setter.Value>
                <ControlTemplate TargetType="{x:Type Label}">
                  <Border>
                    <StackPanel Orientation="Horizontal">
                      <ContentPresenter HorizontalAlignment="{TemplateBinding Control.HorizontalContentAlignment}"
                                        VerticalAlignment="{TemplateBinding Control.VerticalContentAlignment}" RecognizesAccessKey="True"
                                        Margin="0,0,2,0"/>
                      <TextBlock Foreground="{DynamicResource Control.Disabled.Foreground}" FontWeight="Bold"
                                 ToolTip="A newer version is available." Text="!" HorizontalAlignment="Left" Width="15"
                                 Padding="5,0,0,0">
                        <FrameworkElement.Style>
                          <Style TargetType="{x:Type TextBlock}">
                            <Setter Property="UIElement.Visibility" Value="Visible"/>
                            <Style.Triggers>
                              <Trigger Property="UIElement.IsMouseOver" Value="True">
                                <Setter Property="UIElement.Opacity" Value="0.5"/>
                              </Trigger>
                              <DataTrigger Binding="{Binding Path=Tag, ElementName=be}" Value="{x:Null}">
                                <Setter Property="UIElement.Visibility" Value="Collapsed"/>
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </FrameworkElement.Style>
                      </TextBlock>
                    </StackPanel>
                  </Border>
                </ControlTemplate>
              </Setter.Value>
            </Setter>
          </Style>
        </FrameworkElement.Style>
      </Label>
    </Grid>
    <Grid x:Name="bf" Visibility="Collapsed" DataContext="{Binding Path=Plan, ElementName=at}">
      <UIElement.CommandBindings>
        <CommandBinding Command="local:MainWindow.RemoveStep"/>
      </UIElement.CommandBindings>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto" MinHeight="20"/>
        <RowDefinition MinHeight="20"/>
      </Grid.RowDefinitions>
      <gui:TestPlanGrid x:Name="bg" OnPasted="f" TestPlanChanged="testPlanChanged" PropertyChanged="a" MouseDown="a"
                        Focusable="True" Grid.Row="2" AutomationProperties.AutomationId="TestPlanGrid"
                        TestPlan="{Binding Plan, ElementName=at}" ReadOnly="{Binding TestPlanLocked, ElementName=at}"/>
      <TextBlock Name="bh" Style="{StaticResource Tap.TextBlock.HintStyle}" Visibility="Collapsed" Grid.Row="2"
                 VerticalAlignment="Top" Margin="0,70,0,0" HorizontalAlignment="Left"
                 Text="Drag and drop steps here."/>
      <TextBlock Name="bi" Grid.Row="2" Width="250" VerticalAlignment="Top" HorizontalAlignment="Left"
                 Text="Click '+' to add a test step." Margin="2,43,0,0">
        <FrameworkElement.Style>
          <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource Tap.TextBlock.HintStyle}">
            <Setter Property="UIElement.Visibility" Value="Hidden"/>
            <Style.Triggers>
              <DataTrigger Binding="{Binding ChildTestSteps.Count}" Value="0">
                <Setter Property="UIElement.Visibility" Value="Visible"/>
              </DataTrigger>
              <DataTrigger Binding="{Binding FilterMode, ElementName=bg}" Value="True">
                <Setter Property="UIElement.Visibility" Value="Collapsed"/>
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </FrameworkElement.Style>
      </TextBlock>
      <gui:WelcomeScreen x:Name="bj" Grid.Row="2"/>
      <ToolBar Margin="0" Padding="2" Template="{StaticResource ToolBar2}"
               Height="{DynamicResource Tap.ToolBar.Height}" Grid.Row="1" ToolBarTray.IsLocked="True"
               AutomationProperties.AutomationId="TestPlanToolBar" KeyboardNavigation.TabNavigation="Continue"
               Foreground="{DynamicResource GridView.ColumnHeader.Static.Foreground}"
               FontFamily="{DynamicResource {x:Static mgr:FontManager.WslNormalFontFamilyKey}}"
               TextElement.Foreground="{DynamicResource GridView.ColumnHeader.Static.Foreground}">
        <FrameworkElement.Resources>
          <SolidColorBrush x:Key="Button.Static.Background" Color="Transparent"/>
          <controls:Alias x:Key="Button.MouseOver.Background" ResourceKey="ListBox.MouseOver.Background"/>
          <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
            <Setter Property="Control.BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FrameworkElement.VerticalAlignment" Value="Stretch"/>
            <Setter Property="Control.HorizontalContentAlignment" Value="Center"/>
            <Setter Property="FrameworkElement.Width" Value="35"/>
            <Style.Triggers>
              <Trigger Property="UIElement.IsFocused" Value="True">
                <Setter Property="Control.BorderBrush" Value="Transparent"/>
              </Trigger>
            </Style.Triggers>
          </Style>
        </FrameworkElement.Resources>
        <Button DockPanel.Dock="Left" VerticalAlignment="Stretch" ToolTip="Add a test step to test plan (Ctrl+T)."
                Command="local:MainWindow.AddStep" AutomationProperties.AutomationId="AddStepButton"
                CommandTarget="{Binding ElementName=at}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}"/>
          </FrameworkElement.Style>
          <Grid>
            <Border Width="15" Height="1" SnapsToDevicePixels="True" Margin="1"
                    Background="{Binding Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType=Button}}"/>
            <Border Width="1" Height="15" SnapsToDevicePixels="True" Margin="1"
                    Background="{Binding Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType=Button}}"/>
          </Grid>
        </Button>
        <Button DockPanel.Dock="Left" VerticalAlignment="Stretch"
                ToolTip="Remove selected test step from test plan (Delete)." Command="local:MainWindow.RemoveStep"
                AutomationProperties.AutomationId="RemoveStepButton" CommandTarget="{Binding ElementName=bg}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
              <Setter Property="Control.Foreground" Value="{DynamicResource failColor}"/>
              <Style.Triggers>
                <Trigger Property="UIElement.IsEnabled" Value="False">
                  <Setter Property="Control.Foreground" Value="{DynamicResource Control.Disabled.Foreground}"/>
                </Trigger>
              </Style.Triggers>
            </Style>
          </FrameworkElement.Style>
          <Border Width="15" Height="1" SnapsToDevicePixels="True" Margin="1"
                  Background="{Binding (TextElement.Foreground), RelativeSource={RelativeSource Self}}"/>
        </Button>
        <TextBlock VerticalAlignment="Center" Margin="15,0,10,0">Test Plan:</TextBlock>
        <Button DockPanel.Dock="Left" VerticalAlignment="Stretch" VerticalContentAlignment="Center"
                HorizontalContentAlignment="Center" Command="local:MainWindow.InitTestPlan"
                AutomationProperties.AutomationId="InitTestPlanButton" CommandTarget="{Binding ElementName=at}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
              <Setter Property="FrameworkElement.ToolTip" Value="Resources are disconnected, click to open connection."/>
              <Setter Property="Control.BorderBrush" Value="Transparent"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding TestPlanOpened, ElementName=at}" Value="True">
                  <Setter Property="FrameworkElement.ToolTip" Value="Resources are connected, click to close connection."/>
                  <Setter Property="Control.Background" Value="{DynamicResource Button.Static.Background}"/>
                  <Setter Property="Control.BorderBrush" Value="Transparent"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </FrameworkElement.Style>
          <ContentControl.ContentTemplate>
            <DataTemplate>
              <Viewbox Height="20" Width="22">
                <FixedPage Width="800" Height="1000" Margin="800,0,0,0" Background="Transparent">
                  <UIElement.RenderTransform>
                    <RotateTransform Angle="90"/>
                  </UIElement.RenderTransform>
                  <Path x:Name="path"
                        Data="M 465.28,300 L 517.6,300 517.6,368.8 465.28,368.8 M 465.28,688 L 517.6,688 517.6,756.8 465.28,756.8 M 285.92,502.24 L 354.72,502.24 354.72,554.4 285.92,554.4 Z"
                        Margin="-590,-1362,0,0"
                        Fill="{Binding (TextElement.Foreground), RelativeSource={RelativeSource Self}}">
                    <UIElement.RenderTransform>
                      <ScaleTransform ScaleX="2.6" ScaleY="2.6"/>
                    </UIElement.RenderTransform>
                  </Path>
                  <Path x:Name="path2"
                        Data="F1 M 0,0 L -86.72,0 -86.72,78.08 0,78.08 0,186.08 77.92,186.08 77.92,-108 0,-108 Z"
                        Clip="M -167.2,-190.08 L -167.2,267.68 78.4,267.68 78.4,-190.08 Z" Margin="590,-88,0,0"
                        Fill="{Binding (TextElement.Foreground), RelativeSource={RelativeSource Self}}">
                    <UIElement.RenderTransform>
                      <ScaleTransform ScaleX="2.5" ScaleY="2.5"/>
                    </UIElement.RenderTransform>
                  </Path>
                </FixedPage>
              </Viewbox>
              <DataTemplate.Triggers>
                <DataTrigger Value="True"
                             Binding="{Binding TestPlanOpened, RelativeSource={RelativeSource AncestorType=local:MainWindow}}">
                  <Setter TargetName="path" Value="{DynamicResource Tap.Highlight}" Property="Shape.Fill"/>
                  <Setter TargetName="path2" Value="{DynamicResource Tap.Highlight}" Property="Shape.Fill"/>
                </DataTrigger>
              </DataTemplate.Triggers>
            </DataTemplate>
          </ContentControl.ContentTemplate>
        </Button>
        <Button Command="local:MainWindow.RunTestPlan" DockPanel.Dock="Left" VerticalAlignment="Stretch"
                ToolTip="Run test plan (F5)." AutomationProperties.AutomationId="RunTestPlanButton"
                CommandTarget="{Binding ElementName=at}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
              <Setter Property="Control.Foreground" Value="{DynamicResource passColor}"/>
              <Style.Triggers>
                <Trigger Property="UIElement.IsEnabled" Value="False">
                  <Setter Property="Control.Foreground" Value="{DynamicResource Control.Disabled.Foreground}"/>
                </Trigger>
              </Style.Triggers>
            </Style>
          </FrameworkElement.Style>
          <Control Template="{StaticResource Tap.Play}"/>
        </Button>
        <Button DockPanel.Dock="Left" VerticalAlignment="Stretch" CommandTarget="{Binding ElementName=at}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
              <Setter Property="ButtonBase.Command" Value="local:MainWindow.StepTestPlan"/>
              <Setter Property="Control.Foreground" Value="{DynamicResource Tap.Wait.Brush}"/>
              <Setter Property="FrameworkElement.ToolTip" Value="Pause test plan at next possible occasion (F11)."/>
              <Style.Triggers>
                <Trigger Property="UIElement.IsEnabled" Value="False">
                  <Setter Property="Control.Foreground" Value="{DynamicResource Control.Disabled.Foreground}"/>
                </Trigger>
                <MultiDataTrigger>
                  <MultiDataTrigger.Conditions>
                    <Condition Binding="{Binding PlanRunning, ElementName=at}" Value="True"/>
                    <Condition Binding="{Binding SingleSteppingStarted, ElementName=at}" Value="True"/>
                    <Condition Binding="{Binding BreakPointHit, ElementName=at}" Value="False"/>
                  </MultiDataTrigger.Conditions>
                  <Setter Property="Control.Foreground" Value="{DynamicResource Tap.WaitingBrush}"/>
                  <Setter Property="ButtonBase.Command" Value=""/>
                  <Setter Property="FrameworkElement.ToolTip" Value="Waiting to pause."/>
                </MultiDataTrigger>
              </Style.Triggers>
            </Style>
          </FrameworkElement.Style>
          <Control Template="{StaticResource Tap.PlayPause}"/>
        </Button>
        <Button Name="bk" DockPanel.Dock="Left" VerticalAlignment="Stretch"
                ToolTip="Abort test plan execution (Shift-F5)." Command="local:MainWindow.StopTestPlan"
                AutomationProperties.AutomationId="StopTestPlanButton" CommandTarget="{Binding ElementName=at}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
              <Setter Property="Control.Foreground" Value="{DynamicResource failColor}"/>
              <Style.Triggers>
                <Trigger Property="UIElement.IsEnabled" Value="False">
                  <Setter Property="Control.Foreground" Value="{DynamicResource Control.Disabled.Foreground}"/>
                </Trigger>
              </Style.Triggers>
            </Style>
          </FrameworkElement.Style>
          <Control Template="{StaticResource Tap.Stop}"/>
        </Button>
        <controls:ControlDropDown Name="bl" DockPanel.Dock="Left" ToolTip="Repeats the test plan until condition(s) are met."
                                  Placement="Bottom" Opacity="1" AutomationProperties.AutomationId="RepeatTestPlanControl"
                                  IsTabStop="False"
                                  IsEnabled="{Binding Plan.IsRunning, ElementName=at, Converter={controls:InvertBooleanConverter}}"
                                  PlacementTarget="{Binding RelativeSource={RelativeSource Self}}">
          <controls:ControlDropDown.Header>
            <ToggleButton Name="bm" IsHitTestVisible="False" Opacity="1" BorderThickness="0" Padding="0,0"
                          Background="Transparent" AutomationProperties.AutomationId="RepeatTestPlanToggle" IsTabStop="False"
                          IsChecked="{Binding IsRepeatEnabled, ElementName=at}">
              <StackPanel Orientation="Horizontal">
                <Control Template="{StaticResource Tap.Repeat}" Margin="2,0,3,0">
                  <FrameworkElement.Style>
                    <Style TargetType="{x:Type Control}">
                      <Setter Property="TextElement.Foreground" Value="{DynamicResource Control.Disabled.Foreground}"/>
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding IsRepeatEnabled, ElementName=at}" Value="True">
                          <Setter Property="TextElement.Foreground" Value="{DynamicResource Tap.Highlight}"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </FrameworkElement.Style>
                </Control>
                <Decorator Visibility="{Binding IsChecked, ElementName=bm, Converter={StaticResource boolToVisibility}, ConverterParameter={x:Static Visibility.Hidden}}">
                  <TextBlock MinWidth="5" VerticalAlignment="Center" AutomationProperties.AutomationId="RepeatCount"
                             Margin="0,0,2,0" Text="{Binding RepeatCount, ElementName=at}"
                             Visibility="{Binding IsRepeatCountVisible, ElementName=at, Converter={StaticResource boolToVisibility}, ConverterParameter={x:Static Visibility.Hidden}}"/>
                </Decorator>
              </StackPanel>
            </ToggleButton>
          </controls:ControlDropDown.Header>
          <controls:ControlDropDown.DropDownContent>
            <DockPanel>
              <FrameworkElement.Resources>
                <Style TargetType="{x:Type CheckBox}" BasedOn="{StaticResource {x:Type CheckBox}}">
                  <Setter Property="FrameworkElement.Margin" Value="6,6"/>
                  <Setter Property="DockPanel.Dock" Value="Top"/>
                  <Setter Property="UIElement.IsEnabled" Value="{Binding IsRepeatEnabled, ElementName=at}"/>
                </Style>
              </FrameworkElement.Resources>
              <Label DockPanel.Dock="Top" Padding="0" Background="{DynamicResource ToolBar.Static.Background}">
                <CheckBox IsEnabled="True" Margin="6,0"
                          ToolTip="Enable repeating the test plan until a given condition is met."
                          IsChecked="{Binding IsRepeatEnabled, Mode=TwoWay, ElementName=at}">
                  <TextBlock Margin="6,10" VerticalAlignment="Center" Text="Repeat Until:"/>
                </CheckBox>
              </Label>
              <CheckBox ToolTip="Repeat until the test plan passes."
                        IsChecked="{Binding RepeatStopPass, Mode=TwoWay, ElementName=at}">
                <TextBlock Text="Plan Pass"/>
              </CheckBox>
              <CheckBox ToolTip="Repeat until the test plan fails." AutomationProperties.AutomationId="RepeatStopFail"
                        IsChecked="{Binding RepeatStopFail, Mode=TwoWay, ElementName=at}">
                <TextBlock Text="Plan Fail"/>
              </CheckBox>
              <CheckBox ToolTip="Repeat until the test plan is aborted. For example if the stop button is clicked."
                        AutomationProperties.AutomationId="RepeatStopAbort"
                        IsChecked="{Binding RepeatStopAbort, Mode=TwoWay, ElementName=at}">
                <TextBlock Text="Plan Abort"/>
              </CheckBox>
              <CheckBox ToolTip="Repeat until the test plan stops due to an error."
                        AutomationProperties.AutomationId="RepeatStopError"
                        IsChecked="{Binding RepeatStopError, Mode=TwoWay, ElementName=at}">
                <TextBlock Text="Plan Error"/>
              </CheckBox>
              <CheckBox ToolTip="Repeat until the test plan fails to start."
                        AutomationProperties.AutomationId="RepeatStopPending"
                        IsChecked="{Binding RepeatStopPending, Mode=TwoWay, ElementName=at}">
                <TextBlock Text="Plan Failed to Start"/>
              </CheckBox>
              <CheckBox HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch"
                        ToolTip="Repeat the test plan for a number of times."
                        AutomationProperties.AutomationId="RepeatStopCount"
                        IsChecked="{Binding RepeatStopCount, Mode=TwoWay, ElementName=at}">
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock VerticalAlignment="Center" Margin="0,0,5,0" Grid.Column="0" Text="Count "/>
                  <TextBox Width="50" Grid.Column="1" ToolTip="The number of times to repeat the test plan."
                           HorizontalAlignment="Stretch" AutomationProperties.AutomationId="RepeatCountSetter"
                           Text="{Binding MaxRepeatCount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ElementName=at}"/>
                </Grid>
              </CheckBox>
            </DockPanel>
          </controls:ControlDropDown.DropDownContent>
        </controls:ControlDropDown>
        <Control Name="bn">
          <Control.Template>
            <ControlTemplate TargetType="{x:Type Control}">
              <Button Name="btn" Padding="2,0" Width="NaN" Margin="4,0"
                      Command="controls:ExternalTestPlanParameters.ShowCommand" ToolTip="Show test plan settings. Alt+E"
                      CommandTarget="{Binding ElementName=at}">
                <Control Margin="2,0" Template="{StaticResource Tap.GearVisual}"/>
                <FrameworkElement.Style>
                  <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
                    <Setter Property="TextElement.Foreground" Value="{DynamicResource Control.Disabled.Foreground}"/>
                    <Style.Triggers>
                      <Trigger Property="UIElement.IsMouseOver" Value="True">
                        <Setter Property="TextElement.Foreground" Value="{DynamicResource Control.Static.Foreground}"/>
                      </Trigger>
                    </Style.Triggers>
                  </Style>
                </FrameworkElement.Style>
              </Button>
            </ControlTemplate>
          </Control.Template>
        </Control>
        <Control DockPanel.Dock="Left" HorizontalAlignment="Stretch" DataContext="{Binding ElementName=at}">
          <Control.Template>
            <ControlTemplate>
              <Border HorizontalAlignment="Stretch">
                <Grid Name="grid" Tag="{Binding TestPlanListener.AverageDuration}">
                  <controls:AverageProgressBar Name="bar" Background="{DynamicResource ProgressBar.Static.Background}"
                                               HorizontalAlignment="Stretch" Margin="2" Value="{Binding Duration}"
                                               Average="{Binding TestPlanListener.AverageDuration}"/>
                  <TextBlock Name="bigText" HorizontalAlignment="Center" VerticalAlignment="Center"
                             Foreground="{DynamicResource Control.Static.Foreground}">
                    <TextBlock.Text>
                      <MultiBinding Converter="{StaticResource remainingTextConverter}">
                        <Binding Path="Value" ElementName="bar"/>
                        <Binding Path="TestPlanListener.AverageDuration"/>
                        <Binding Path="Plan.IsRunning"/>
                        <Binding Path="TestPlanListener.Verdict"/>
                      </MultiBinding>
                    </TextBlock.Text>
                  </TextBlock>
                  <controls:SimpleTextLine Name="smallText" HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="Hidden"
                                           TextElement.Foreground="{DynamicResource Control.Static.Foreground}">
                    <controls:SimpleTextLine.Text>
                      <MultiBinding Converter="{StaticResource remainingTextConverter}" ConverterParameter="slim">
                        <Binding Path="Value" ElementName="bar"/>
                        <Binding Path="TestPlanListener.AverageDuration"/>
                        <Binding Path="Plan.IsRunning"/>
                        <Binding Path="TestPlanListener.Verdict"/>
                      </MultiBinding>
                    </controls:SimpleTextLine.Text>
                  </controls:SimpleTextLine>
                  <FrameworkElement.ToolTip>
                    <ToolTip DataContext="{Binding Path=PlacementTarget, RelativeSource={x:Static RelativeSource.Self}}">
                      <TextBlock>
                        Expected duration (average based on previous runs):
                        <TextBlock Text="{Binding Tag, StringFormat={0:F2}}"/>
                        s
                      </TextBlock>
                    </ToolTip>
                  </FrameworkElement.ToolTip>
                </Grid>
              </Border>
              <ControlTemplate.Triggers>
                <DataTrigger Value="0" Binding="{Binding Value, ElementName=bar}">
                  <Setter Property="UIElement.Visibility" Value="Hidden"/>
                </DataTrigger>
                <DataTrigger Value="False" Binding="{Binding TestPlanListener.AverageDurationKnown}">
                  <Setter TargetName="bar" Property="controls:AverageProgressBar.IsIndeterminate" Value="True"/>
                  <Setter TargetName="grid" Value="{x:Null}" Property="FrameworkElement.ToolTip"/>
                </DataTrigger>
                <DataTrigger Value="False" Binding="{Binding TestPlanListener.IsRunning}">
                  <Setter TargetName="bar" Value="{DynamicResource Tap.Panel.BackgroundMedium}" Property="Control.Foreground"/>
                  <Setter TargetName="bar" Value="{DynamicResource Tap.Panel.Background}" Property="Control.Background"/>
                  <Setter TargetName="bar" Property="controls:AverageProgressBar.IsIndeterminate" Value="False"/>
                </DataTrigger>
                <DataTrigger Value="True">
                  <DataTrigger.Binding>
                    <MultiBinding Converter="{controls:BiggerThanConverter}">
                      <MultiBinding.Bindings>
                        <Binding Path="ActualWidth" ElementName="bigText"/>
                        <Binding Path="ActualWidth" ElementName="grid"/>
                      </MultiBinding.Bindings>
                    </MultiBinding>
                  </DataTrigger.Binding>
                  <Setter TargetName="bigText" Property="UIElement.Visibility" Value="Hidden"/>
                  <Setter TargetName="smallText" Property="UIElement.Visibility" Value="Visible"/>
                </DataTrigger>
              </ControlTemplate.Triggers>
            </ControlTemplate>
          </Control.Template>
        </Control>
      </ToolBar>
      <ContentControl Grid.Row="1" Grid.RowSpan="2" Style="{StaticResource LoadingOverlay}"
                      Content="{Binding TestPlanProgressMessage, ElementName=at}"/>
      <Decorator Name="bo" Grid.Row="0" Grid.RowSpan="3"/>
    </Grid>
    <Grid x:Name="bp" Visibility="Collapsed" KeyboardNavigation.IsTabStop="False" Focusable="False"
          DataContext="{Binding Path=Plan, ElementName=at}">
      <Grid Name="bq" KeyboardNavigation.IsTabStop="False" Focusable="False"
            IsEnabled="{Binding GotLicense, ElementName=at}">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <controls:PropGrid x:Name="br" Grid.Row="1" IsTabStop="False" Focusable="False"
                           Background="{DynamicResource Tap.Panel.Background}" MultiSelectEnabled="true"
                           FontSize="{DynamicResource WslMediumFontSizeKey}" AutomationProperties.AutomationId="StepSettings"
                           DebugMode="{Binding Source={x:Static controls:EditorSettings.Current}, Path=ShowPropertyInTooltip}"
                           DataContext="{Binding ElementName=bg, Path=SelectedTestSteps}">
          <FrameworkElement.Style>
            <Style TargetType="{x:Type controls:PropGrid}" BasedOn="{StaticResource {x:Type controls:PropGrid}}">
              <Setter Property="controls:PropGrid.ContentEnabled" Value="True"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding TestPlanLocked, ElementName=at}" Value="True">
                  <Setter Property="controls:PropGrid.ContentEnabled" Value="False"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TestPlanProgressMessage, ElementName=at, Converter={controls:IsNotNullConverter}}"
                             Value="True">
                  <Setter Property="controls:PropGrid.ContentEnabled" Value="False"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </FrameworkElement.Style>
          <FrameworkElement.ContextMenu>
            <ContextMenu>
              <MenuItem Command="local:MainWindow.Undo"
                        CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}"/>
              <MenuItem Command="local:MainWindow.Redo"
                        CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}"/>
            </ContextMenu>
          </FrameworkElement.ContextMenu>
          <controls:PropGrid.ContextTemplate>
            <DataTemplate DataType="controls:ItemUi">
              <ItemsControl ItemsSource="{Binding MenuItems}"/>
            </DataTemplate>
          </controls:PropGrid.ContextTemplate>
        </controls:PropGrid>
      </Grid>
      <TextBlock Name="bs" TextWrapping="Wrap" TextTrimming="CharacterEllipsis" VerticalAlignment="Bottom"
                 HorizontalAlignment="Right" Text="Select a test step to view settings." LineHeight="20"
                 MaxHeight="100" KeyboardNavigation.IsTabStop="False" Focusable="False">
        <FrameworkElement.Style>
          <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource Tap.TextBlock.HintStyle}">
            <Setter Property="UIElement.Visibility" Value="Hidden"/>
            <Style.Triggers>
              <MultiDataTrigger>
                <MultiDataTrigger.Conditions>
                  <Condition Binding="{Binding SelectedTestStep, ElementName=bg}" Value="{x:Null}"/>
                  <Condition Binding="{Binding Plan.IsRunning, ElementName=at}" Value="False"/>
                  <Condition Binding="{Binding Path=ChildTestSteps.Count, Converter={StaticResource intNotZeroToBoolConverter}}">
                    <Condition.Value>
                      <system:Boolean>True</system:Boolean>
                    </Condition.Value>
                  </Condition>
                </MultiDataTrigger.Conditions>
                <MultiDataTrigger.Setters>
                  <Setter Property="UIElement.Visibility" Value="Visible"/>
                </MultiDataTrigger.Setters>
              </MultiDataTrigger>
            </Style.Triggers>
          </Style>
        </FrameworkElement.Style>
      </TextBlock>
    </Grid>
    <Grid x:Name="bt" Visibility="Collapsed" ZIndex="1" KeyboardNavigation.IsTabStop="False">
      <Grid.RowDefinitions>
        <RowDefinition Height="auto"/>
        <RowDefinition/>
      </Grid.RowDefinitions>
      <controls:LogPanel Name="bu" Grid.Row="1" Focusable="False" KeyboardNavigation.IsTabStop="False"
                         AutomationProperties.AutomationId="LogPanel"
                         MaxMessages="{Binding Source={x:Static controls:EditorSettings.Current}, Path=LogPanelBufferSize}"
                         ViewDebug="{Binding ViewDebug, Source={x:Static controls:EditorSettings.Current}, Mode=TwoWay}"
                         ViewMessages="{Binding ViewMessages, Source={x:Static controls:EditorSettings.Current}, Mode=TwoWay}"
                         ViewWarnings="{Binding ViewWarnings, Source={x:Static controls:EditorSettings.Current}, Mode=TwoWay}"
                         ViewErrors="{Binding ViewErrors, Source={x:Static controls:EditorSettings.Current}, Mode=TwoWay}"/>
      <TextBlock Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center">
        <TextBlock FontSize="20" Opacity="0.3" Text="GUI Log Disabled"/>
        <FrameworkElement.Style>
          <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
            <Style.Triggers>
              <DataTrigger Binding="{Binding ElementName=at, Path=LogEnabled, UpdateSourceTrigger=PropertyChanged}"
                           Value="True">
                <Setter Property="UIElement.Visibility" Value="Collapsed"/>
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </FrameworkElement.Style>
      </TextBlock>
      <gui:RunCompletedOverlay x:Name="bv" IsHitTestVisible="False" Grid.Row="1"/>
    </Grid>
    <gui:TapDock x:Name="bw"/>
    <gui:InstrumentStatus x:Name="bx" Background="{DynamicResource DataGrid.ColumnHeader.Static.Background}"
                          VerticalAlignment="Stretch" Grid.Row="1" IsEnabled="{Binding GotLicense, ElementName=at}"
                          Visibility="{Binding FocusModeEnabled, ElementName=at, Converter={controls:VisibilityConverter}, ConverterParameter={x:Static Visibility.Visible}}"
                          DataContext="{Binding TapSettings, ElementName=at}"/>
  </Grid>
</gui:MainWindow>